{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"factoryName": {
			"type": "string",
			"metadata": "Data Factory name",
			"defaultValue": "HoeveBoveneindADF"
		},
		"Nedap_API_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://api.nedap-bi.com/v1/"
		}
	},
	"variables": {
		"factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('factoryName'), '/table_staging_nedapcowlying')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DWH_Hoeve_boveneind",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "staging"
				},
				"annotations": [],
				"type": "AzurePostgreSqlTable",
				"schema": [],
				"typeProperties": {
					"schema": "staging",
					"table": "nedapcowlying"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/table_staging_nedapcowstanding')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DWH_Hoeve_boveneind",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "staging"
				},
				"annotations": [],
				"type": "AzurePostgreSqlTable",
				"schema": [
					{
						"name": "animal_id",
						"type": "bigint",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "total",
						"type": "integer",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "quarter",
						"type": "timestamp without time zone",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "status",
						"type": "integer",
						"precision": 0,
						"scale": 0
					}
				],
				"typeProperties": {
					"schema": "staging",
					"table": "nedapcowstanding"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/table_staging_nedapcowstandups')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DWH_Hoeve_boveneind",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "staging"
				},
				"annotations": [],
				"type": "AzurePostgreSqlTable",
				"schema": [
					{
						"name": "animal_id",
						"type": "bigint",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "total",
						"type": "integer",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "quarter",
						"type": "timestamp without time zone",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "status",
						"type": "integer",
						"precision": 0,
						"scale": 0
					}
				],
				"typeProperties": {
					"schema": "staging",
					"table": "nedapcowstandups"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/table_staging_nedapcowsteps')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DWH_Hoeve_boveneind",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "staging"
				},
				"annotations": [],
				"type": "AzurePostgreSqlTable",
				"schema": [
					{
						"name": "animal_id",
						"type": "bigint",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "total",
						"type": "integer",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "quarter",
						"type": "timestamp without time zone",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "status",
						"type": "integer",
						"precision": 0,
						"scale": 0
					}
				],
				"typeProperties": {
					"schema": "staging",
					"table": "nedapcowsteps"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/table_staging_nedapcowwalking')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DWH_Hoeve_boveneind",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "staging"
				},
				"annotations": [],
				"type": "AzurePostgreSqlTable",
				"schema": [
					{
						"name": "animal_id",
						"type": "bigint",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "total",
						"type": "integer",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "quarter",
						"type": "timestamp without time zone",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "status",
						"type": "integer",
						"precision": 0,
						"scale": 0
					}
				],
				"typeProperties": {
					"schema": "staging",
					"table": "nedapcowwalking"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/table_staging_nedapheatdetection')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DWH_Hoeve_boveneind",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "staging"
				},
				"annotations": [],
				"type": "AzurePostgreSqlTable",
				"schema": [
					{
						"name": "animal_id",
						"type": "bigint",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "quarter",
						"type": "timestamp without time zone",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "total",
						"type": "integer",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "status",
						"type": "integer",
						"precision": 0,
						"scale": 0
					}
				],
				"typeProperties": {
					"schema": "staging",
					"table": "nedapheatdetection"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/table_staging_nedaplocationdata')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DWH_Hoeve_boveneind",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "staging"
				},
				"annotations": [],
				"type": "AzurePostgreSqlTable",
				"schema": [
					{
						"name": "timestamp",
						"type": "timestamp without time zone",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "responder",
						"type": "bigint",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "x",
						"type": "bigint",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "y",
						"type": "bigint",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "quality",
						"type": "bigint",
						"precision": 0,
						"scale": 0
					}
				],
				"typeProperties": {
					"schema": "staging",
					"table": "nedaplocationdata"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/view_staging_CowIDView')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DWH_Hoeve_boveneind",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "staging"
				},
				"annotations": [],
				"type": "AzurePostgreSqlTable",
				"schema": [
					{
						"name": "id",
						"type": "bigint",
						"precision": 0,
						"scale": 0
					}
				],
				"typeProperties": {
					"schema": "staging",
					"table": "CowIDView"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/view_staging_StagingCowView')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "DWH_Hoeve_boveneind",
					"type": "LinkedServiceReference"
				},
				"folder": {
					"name": "staging"
				},
				"annotations": [],
				"type": "AzurePostgreSqlTable",
				"schema": [
					{
						"name": "id",
						"type": "bigint",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "condition",
						"type": "character varying",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "life_number",
						"type": "character varying",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "responder1",
						"type": "bigint",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "responder2",
						"type": "bigint",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "responder3",
						"type": "character varying",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "number",
						"type": "integer",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "uuid",
						"type": "character varying",
						"precision": 0,
						"scale": 0
					},
					{
						"name": "group_id",
						"type": "integer",
						"precision": 0,
						"scale": 0
					}
				],
				"typeProperties": {
					"schema": "staging",
					"table": "StagingCowView"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/Nedap_API')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "RestService",
				"typeProperties": {
					"url": "[parameters('Nedap_API_properties_typeProperties_url')]",
					"enableServerCertificateValidation": true,
					"authenticationType": "Anonymous",
					"authHeaders": {
						"Authorization": {
							"type": "AzureKeyVaultSecret",
							"store": {
								"referenceName": "boveneindkeyvaultt_access_token",
								"type": "LinkedServiceReference"
							},
							"secretName": "access-token"
						}
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/V2 DWH Lookup Behaviour Flowlet')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "Flowlet",
				"typeProperties": {
					"sources": [
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimTime"
						},
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimDate"
						},
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimCows"
						}
					],
					"sinks": [],
					"transformations": [
						{
							"name": "CowLookup",
							"description": "Voegt data staging area samen met bron: DWHValidCows en filtert op koeien waarvan de animal_id gelijk is aan het nedapid.\n\n"
						},
						{
							"name": "SplitDatetime"
						},
						{
							"name": "TimeLookup"
						},
						{
							"name": "DateLookup"
						},
						{
							"name": "NullFilter"
						},
						{
							"name": "activeDBcows"
						},
						{
							"name": "CowBehaviourStaging",
							"description": "Staging area data cow behaviour"
						},
						{
							"name": "CowBehaviour"
						}
					],
					"scriptLines": [
						"input(output(",
						"          animal_id as long,",
						"          start_time as timestamp,",
						"          type as integer,",
						"          duration as integer,",
						"          status as integer",
						"     ),",
						"     order: 0) ~> CowBehaviourStaging",
						"source(output(",
						"          dim_time_id as integer,",
						"          time as timestamp,",
						"          minute as integer,",
						"          hour as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_time',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimTime",
						"source(output(",
						"          dim_date_id as integer,",
						"          date as date,",
						"          day as integer,",
						"          day_name as string,",
						"          week as integer,",
						"          iso_week as integer,",
						"          day_of_week as integer,",
						"          month as integer,",
						"          month_name as string,",
						"          quarter as integer,",
						"          year as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_date',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimDate",
						"source(output(",
						"          dim_cow_id as integer,",
						"          lifenumber as string,",
						"          leg_responder as long,",
						"          neck_responder as long,",
						"          cownumber as integer,",
						"          nedap_id as long,",
						"          start_date as date,",
						"          end_date as date,",
						"          group as integer,",
						"          last_updated as timestamp",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_cow',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimCows",
						"CowBehaviourStaging, activeDBcows lookup(animal_id == nedap_id,",
						"     multiple: true,",
						"     broadcast: 'right',",
						"     pickup: 'any')~> CowLookup",
						"CowLookup derive({time calc} = trim(split(toString(start_time),' ')[2]),",
						"          {date calc} = trim(split(toString(start_time),' ')[1])) ~> SplitDatetime",
						"SplitDatetime, DimTime lookup({time calc} == trim(split(toString(time),' ')[2]),",
						"     multiple: true,",
						"     broadcast: 'right')~> TimeLookup",
						"TimeLookup, DimDate lookup({date calc} == toString(date),",
						"     multiple: true,",
						"     broadcast: 'right')~> DateLookup",
						"DateLookup filter(isNull(dim_cow_id) == false() && isNull(dim_date_id) == false() && isNull(dim_time_id) == false()) ~> NullFilter",
						"DimCows filter(isNull(end_date) == true()) ~> activeDBcows",
						"NullFilter output(mapColumn(",
						"          dim_cow_id,",
						"          dim_time_id,",
						"          dim_date_id,",
						"          type,",
						"          duration",
						"     )) ~> CowBehaviour"
					]
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/V2 DWH Lookup Eating Flowlet')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "Copy of DWHLookupFlowlet ",
				"type": "Flowlet",
				"typeProperties": {
					"sources": [
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimDate"
						},
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimTime"
						},
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimCows"
						}
					],
					"sinks": [],
					"transformations": [
						{
							"name": "CowLookup"
						},
						{
							"name": "DateLookup"
						},
						{
							"name": "TimeLookup"
						},
						{
							"name": "SplitDateTime"
						},
						{
							"name": "NullFilter"
						},
						{
							"name": "DatatypeConversie"
						},
						{
							"name": "activeDBcow"
						},
						{
							"name": "CowEatingStaging"
						},
						{
							"name": "CowEating"
						}
					],
					"scriptLines": [
						"input(output(",
						"          animal_id as long,",
						"          date as timestamp,",
						"          total as integer,",
						"          average as integer,",
						"          attention as string",
						"     ),",
						"     order: 0) ~> CowEatingStaging",
						"source(output(",
						"          dim_date_id as integer,",
						"          date as date,",
						"          day as integer,",
						"          day_name as string,",
						"          week as integer,",
						"          iso_week as integer,",
						"          day_of_week as integer,",
						"          month as integer,",
						"          month_name as string,",
						"          quarter as integer,",
						"          year as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_date',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimDate",
						"source(output(",
						"          dim_time_id as integer,",
						"          time as timestamp,",
						"          minute as integer,",
						"          hour as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_time',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimTime",
						"source(output(",
						"          dim_cow_id as integer,",
						"          lifenumber as string,",
						"          leg_responder as long,",
						"          neck_responder as long,",
						"          cownumber as integer,",
						"          nedap_id as long,",
						"          start_date as date,",
						"          end_date as date,",
						"          group as integer,",
						"          last_updated as timestamp",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_cow',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimCows",
						"CowEatingStaging, activeDBcow lookup(animal_id == nedap_id,",
						"     multiple: true,",
						"     broadcast: 'right')~> CowLookup",
						"SplitDateTime, DimDate lookup(DateCalc == toString(DimDate@date),",
						"     multiple: true,",
						"     broadcast: 'right')~> DateLookup",
						"DateLookup, DimTime lookup(TimeCalc == trim(split(toString(time),' ')[2]),",
						"     multiple: true,",
						"     broadcast: 'right')~> TimeLookup",
						"DatatypeConversie derive(DateCalc = trim(split(toString(date),' ')[1]),",
						"          TimeCalc = trim(split(toString(date),' ')[2])) ~> SplitDateTime",
						"TimeLookup filter(isNull(dim_cow_id) == false() && isNull(dim_date_id) == false() && isNull(dim_time_id) == false()) ~> NullFilter",
						"CowLookup derive(attention = toBoolean(attention)) ~> DatatypeConversie",
						"DimCows filter(isNull(end_date) == true()) ~> activeDBcow",
						"NullFilter output(mapColumn(",
						"          total,",
						"          average,",
						"          attention,",
						"          dim_cow_id,",
						"          dim_date_id,",
						"          dim_time_id",
						"     )) ~> CowEating"
					]
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/V2 DWH Lookup Leg Activity Flowlet')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "Flowlet",
				"typeProperties": {
					"sources": [
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimDate"
						},
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimTime"
						},
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimCow"
						}
					],
					"sinks": [],
					"transformations": [
						{
							"name": "CowLookup"
						},
						{
							"name": "DateLookup"
						},
						{
							"name": "TimeLookup"
						},
						{
							"name": "SplitDateTime"
						},
						{
							"name": "NullFilter"
						},
						{
							"name": "activeDBcows"
						},
						{
							"name": "StagingInput"
						},
						{
							"name": "DWHOutput"
						}
					],
					"scriptLines": [
						"input(output(",
						"          animal_id as long,",
						"          quarter as timestamp,",
						"          total_time_lying as integer,",
						"          total_time_standing as integer,",
						"          total_time_walking as integer,",
						"          total_standups as integer,",
						"          total_steps as integer",
						"     ),",
						"     order: 0) ~> StagingInput",
						"source(output(",
						"          dim_date_id as integer,",
						"          date as date,",
						"          day as integer,",
						"          day_name as string,",
						"          week as integer,",
						"          iso_week as integer,",
						"          day_of_week as integer,",
						"          month as integer,",
						"          month_name as string,",
						"          quarter as integer,",
						"          year as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_date',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimDate",
						"source(output(",
						"          dim_time_id as integer,",
						"          time as timestamp,",
						"          minute as integer,",
						"          hour as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_time',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimTime",
						"source(output(",
						"          dim_cow_id as integer,",
						"          lifenumber as string,",
						"          leg_responder as long,",
						"          neck_responder as long,",
						"          cownumber as integer,",
						"          nedap_id as long,",
						"          start_date as date,",
						"          end_date as date,",
						"          group as integer,",
						"          last_updated as timestamp",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_cow',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimCow",
						"StagingInput, activeDBcows lookup(animal_id == nedap_id,",
						"     multiple: true,",
						"     broadcast: 'right')~> CowLookup",
						"SplitDateTime, DimDate lookup(DateCalc == toString(date),",
						"     multiple: true,",
						"     broadcast: 'right')~> DateLookup",
						"DateLookup, DimTime lookup(TimeCalc == trim(split(toString(time),' ')[2]),",
						"     multiple: true,",
						"     broadcast: 'right')~> TimeLookup",
						"CowLookup derive(DateCalc = trim(split(toString(quarter),' ')[1]),",
						"          TimeCalc = trim(split(toString(quarter),' ')[2])) ~> SplitDateTime",
						"TimeLookup filter(isNull(dim_cow_id) == false() && isNull(dim_date_id) == false() && isNull(dim_time_id) == false()) ~> NullFilter",
						"DimCow filter(isNull(end_date) == true()) ~> activeDBcows",
						"NullFilter output(mapColumn(",
						"          dim_cow_id,",
						"          dim_date_id,",
						"          dim_time_id,",
						"          total_time_lying,",
						"          total_time_standing,",
						"          total_time_walking,",
						"          total_standups,",
						"          total_steps",
						"     )) ~> DWHOutput"
					]
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/V2 DWH Lookup Location Flowlet')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "Flowlet",
				"typeProperties": {
					"sources": [
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimDate"
						},
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimCow"
						}
					],
					"sinks": [],
					"transformations": [
						{
							"name": "CowLookup"
						},
						{
							"name": "SplitDatetime"
						},
						{
							"name": "DateLookup"
						},
						{
							"name": "Nullfilter"
						},
						{
							"name": "activeDBcows"
						},
						{
							"name": "LocationStaging"
						},
						{
							"name": "CowLocation"
						}
					],
					"scriptLines": [
						"input(output(",
						"          timestamp as timestamp,",
						"          responder as long,",
						"          x as long,",
						"          y as long,",
						"          quality as long",
						"     ),",
						"     order: 0) ~> LocationStaging",
						"source(output(",
						"          dim_date_id as integer,",
						"          date as date,",
						"          day as integer,",
						"          day_name as string,",
						"          week as integer,",
						"          iso_week as integer,",
						"          day_of_week as integer,",
						"          month as integer,",
						"          month_name as string,",
						"          quarter as integer,",
						"          year as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_date',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimDate",
						"source(output(",
						"          dim_cow_id as integer,",
						"          lifenumber as string,",
						"          leg_responder as long,",
						"          neck_responder as long,",
						"          cownumber as integer,",
						"          start_date as date,",
						"          end_date as date,",
						"          GROUP as integer,",
						"          last_updated as timestamp",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_cow',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimCow",
						"LocationStaging, activeDBcows lookup(responder == neck_responder,",
						"     multiple: false,",
						"     pickup: 'any',",
						"     broadcast: 'auto')~> CowLookup",
						"CowLookup derive({date calc} = trim(split(toString(timestamp),' ')[1])) ~> SplitDatetime",
						"SplitDatetime, DimDate lookup({date calc} == toString(date),",
						"     multiple: false,",
						"     pickup: 'any',",
						"     broadcast: 'auto')~> DateLookup",
						"DateLookup filter(isNull(dim_cow_id) == false() && isNull(dim_date_id) == false()) ~> Nullfilter",
						"DimCow filter(isNull(end_date) == true()) ~> activeDBcows",
						"Nullfilter output(mapColumn(",
						"          each(match(true()))",
						"     )) ~> CowLocation"
					]
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/V2 DWH Lookup Milking Flowlet')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "Flowlet",
				"typeProperties": {
					"sources": [
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimTime"
						},
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimDate"
						},
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimMilkingCode"
						},
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimCow"
						}
					],
					"sinks": [],
					"transformations": [
						{
							"name": "CowLookup"
						},
						{
							"name": "SplitDatetime"
						},
						{
							"name": "TimeLookup"
						},
						{
							"name": "DateLookup"
						},
						{
							"name": "ErrorCodeLookup"
						},
						{
							"name": "NullFilter"
						},
						{
							"name": "activeDBcows"
						},
						{
							"name": "Milkstaging"
						},
						{
							"name": "CowMilkings"
						}
					],
					"scriptLines": [
						"input(output(",
						"          koenummer as integer,",
						"          lactatienummer as integer,",
						"          {Kwartier geleidbaarheid ruwe waarde rechts achter} as integer,",
						"          {Kwartier geleidbaarheid ruwe waarde links achter} as integer,",
						"          {Kwartier geleidbaarheid ruwe waarde links voor} as integer,",
						"          {Kwartier geleidbaarheid ruwe waarde rechts voor} as integer,",
						"          {Robotbezoek datetime} as timestamp,",
						"          lactatiedagen as integer,",
						"          respondernummer as long,",
						"          {Aantal beker aansluitpogingen rechts achter} as integer,",
						"          {Aantal beker aansluitpogingen links achter} as integer,",
						"          {Aantal beker aansluitpogingen links voor} as integer,",
						"          {Aantal beker aansluitpogingen rechts voor} as integer,",
						"          melkduur as integer,",
						"          {Melkstroomherkenningstijd lv} as integer,",
						"          {Melkstroomherkenningstijd rv} as integer,",
						"          {Melkstroomherkenningstijd la} as integer,",
						"          {Melkstroomherkenningstijd ra} as integer,",
						"          melkhoeveelheid as float,",
						"          {Error code} as integer,",
						"          koeleeftijd as integer,",
						"          {Roodheidsgraad achter rechts} as integer,",
						"          {Roodheidsgraad achter links} as integer,",
						"          {Roodheidsgraad vooraan links} as integer,",
						"          {Roodheidsgraad vooraan rechts} as integer",
						"     ),",
						"     order: 0) ~> Milkstaging",
						"source(output(",
						"          dim_time_id as integer,",
						"          time as timestamp,",
						"          minute as integer,",
						"          hour as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_time',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimTime",
						"source(output(",
						"          dim_date_id as integer,",
						"          date as date,",
						"          day as integer,",
						"          day_name as string,",
						"          week as integer,",
						"          iso_week as integer,",
						"          day_of_week as integer,",
						"          month as integer,",
						"          month_name as string,",
						"          quarter as integer,",
						"          year as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_date',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimDate",
						"source(output(",
						"          dim_error_code_id as integer,",
						"          code as integer,",
						"          description as string",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_milking_code',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimMilkingCode",
						"source(output(",
						"          dim_cow_id as integer,",
						"          lifenumber as string,",
						"          leg_responder as long,",
						"          neck_responder as long,",
						"          cownumber as integer,",
						"          nedap_id as long,",
						"          start_date as date,",
						"          end_date as date,",
						"          group as integer,",
						"          last_updated as timestamp",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_cow',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimCow",
						"Milkstaging, activeDBcows lookup(koenummer == cownumber,",
						"     multiple: true,",
						"     broadcast: 'right',",
						"     pickup: 'any')~> CowLookup",
						"CowLookup derive({time calc} = trim(split(toString({Robotbezoek datetime}),' ')[2]),",
						"          {date calc} = trim(split(toString({Robotbezoek datetime}),' ')[1])) ~> SplitDatetime",
						"SplitDatetime, DimTime lookup({time calc} == trim(split(toString(time),' ')[2]),",
						"     multiple: true,",
						"     broadcast: 'right')~> TimeLookup",
						"TimeLookup, DimDate lookup({date calc} == toString(date),",
						"     multiple: true,",
						"     broadcast: 'right')~> DateLookup",
						"DateLookup, DimMilkingCode lookup({Error code} == code,",
						"     multiple: false,",
						"     pickup: 'any',",
						"     broadcast: 'right')~> ErrorCodeLookup",
						"ErrorCodeLookup filter(isNull(dim_cow_id) == false() && isNull(dim_date_id) == false() && isNull(dim_time_id) == false()) ~> NullFilter",
						"DimCow filter(isNull(end_date) == true()) ~> activeDBcows",
						"NullFilter output(mapColumn(",
						"          dim_cow_id,",
						"          dim_error_code_id,",
						"          dim_time_id,",
						"          dim_date_id,",
						"          quarterconductbr = {Kwartier geleidbaarheid ruwe waarde rechts achter},",
						"          quarterconductbl = {Kwartier geleidbaarheid ruwe waarde links achter},",
						"          quarterconductfl = {Kwartier geleidbaarheid ruwe waarde links voor},",
						"          quarterconductfr = {Kwartier geleidbaarheid ruwe waarde rechts voor},",
						"          degreeofrednessbr = {Roodheidsgraad achter rechts},",
						"          degreeofrednessbl = {Roodheidsgraad achter links},",
						"          degreeofrednessfl = {Roodheidsgraad vooraan links},",
						"          degreeofrednessfr = {Roodheidsgraad vooraan rechts},",
						"          nrconnectattemptbr = {Aantal beker aansluitpogingen rechts achter},",
						"          nrconnectattemptbl = {Aantal beker aansluitpogingen links achter},",
						"          nrconnectattemptfl = {Aantal beker aansluitpogingen links voor},",
						"          nrconnectattemptfr = {Aantal beker aansluitpogingen rechts voor},",
						"          milkingtimeudderbr = {Melkstroomherkenningstijd ra},",
						"          milkingtimeudderbl = {Melkstroomherkenningstijd la},",
						"          milkingtimeudderfl = {Melkstroomherkenningstijd lv},",
						"          milkingtimeudderfr = {Melkstroomherkenningstijd rv},",
						"          visitmilkamount = melkhoeveelheid,",
						"          lactationdays = lactatiedagen,",
						"          cowage = koeleeftijd,",
						"          lactationnumer = lactatienummer,",
						"          milkingtimetotal = melkduur",
						"     )) ~> CowMilkings"
					]
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/V2 DWH Lookup Neck Activity Flowlet')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "Flowlet",
				"typeProperties": {
					"sources": [
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimDate"
						},
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimTime"
						},
						{
							"linkedService": {
								"referenceName": "DWH_Hoeve_boveneind",
								"type": "LinkedServiceReference"
							},
							"name": "DimCow"
						}
					],
					"sinks": [],
					"transformations": [
						{
							"name": "CowLookup"
						},
						{
							"name": "SplitDateTime"
						},
						{
							"name": "dateLookup"
						},
						{
							"name": "timeLookup"
						},
						{
							"name": "filter1"
						},
						{
							"name": "StagingInput"
						},
						{
							"name": "DWHOutput"
						}
					],
					"scriptLines": [
						"input(output(",
						"          animal_id as long,",
						"          quarter as timestamp,",
						"          total as integer",
						"     ),",
						"     order: 0) ~> StagingInput",
						"source(output(",
						"          dim_date_id as integer,",
						"          date as date,",
						"          day as integer,",
						"          day_name as string,",
						"          week as integer,",
						"          iso_week as integer,",
						"          day_of_week as integer,",
						"          month as integer,",
						"          month_name as string,",
						"          quarter as integer,",
						"          year as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_date',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimDate",
						"source(output(",
						"          dim_time_id as integer,",
						"          time as timestamp,",
						"          minute as integer,",
						"          hour as integer",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_time',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimTime",
						"source(output(",
						"          dim_cow_id as integer,",
						"          lifenumber as string,",
						"          leg_responder as long,",
						"          neck_responder as long,",
						"          cownumber as integer,",
						"          nedap_id as long,",
						"          start_date as date,",
						"          end_date as date,",
						"          group as integer,",
						"          last_updated as timestamp",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     format: 'table',",
						"     tableName: 'dim_cow',",
						"     schemaName: 'warehouse',",
						"     store: 'postgres',",
						"     isolationLevel: 'READ_UNCOMMITTED') ~> DimCow",
						"StagingInput, DimCow lookup(animal_id == nedap_id,",
						"     multiple: true,",
						"     broadcast: 'right')~> CowLookup",
						"CowLookup derive(DateCalc = trim(split(toString(quarter),' ')[1]),",
						"          TimeCalc = trim(split(toString(quarter),' ')[2])) ~> SplitDateTime",
						"SplitDateTime, DimDate lookup(DateCalc == toString(date),",
						"     multiple: true,",
						"     broadcast: 'auto')~> dateLookup",
						"dateLookup, DimTime lookup(TimeCalc == trim(split(toString(time),' ')[2]),",
						"     multiple: true,",
						"     broadcast: 'auto')~> timeLookup",
						"timeLookup filter(isNull(dim_cow_id) == false() && isNull(dim_date_id) == false() && isNull(dim_time_id) == false()) ~> filter1",
						"filter1 output(mapColumn(",
						"          total,",
						"          dim_cow_id,",
						"          dim_time_id,",
						"          dim_date_id",
						"     )) ~> DWHOutput"
					]
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/API_GetCowBehaviour')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "Nedap_API",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"id": {
						"type": "string"
					},
					"start_date": {
						"type": "string"
					},
					"end_date": {
						"type": "string"
					}
				},
				"folder": {
					"name": "Nedap API"
				},
				"annotations": [],
				"type": "RestResource",
				"typeProperties": {
					"relativeUrl": {
						"value": "@concat('https://api.nedap-bi.com/v1/behaviour/period_behaviour/animal/period_behaviour?animal_id=',dataset().id,'&start_date=',startOfDay(dataset().start_date),'&end_date=',startOfDay(dataset().end_date))",
						"type": "Expression"
					}
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/Nedap_API')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/API_GetCowEating')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "Nedap_API",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"id": {
						"type": "string"
					},
					"start_date": {
						"type": "string"
					},
					"end_date": {
						"type": "string"
					}
				},
				"folder": {
					"name": "Nedap API"
				},
				"annotations": [],
				"type": "RestResource",
				"typeProperties": {
					"relativeUrl": {
						"value": "@concat('https://api.nedap-bi.com/v1/behaviour/eating/animal/day_summaries?animal_id=',dataset().id,'&start_date=',startOfDay(dataset().start_date),'&end_date=',startOfDay(dataset().end_date))",
						"type": "Expression"
					}
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/Nedap_API')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/API_GetCowLegActivity')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "Nedap_API",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"id": {
						"type": "string"
					},
					"start_date": {
						"type": "string"
					},
					"end_date": {
						"type": "string"
					}
				},
				"folder": {
					"name": "Nedap API"
				},
				"annotations": [],
				"type": "RestResource",
				"typeProperties": {
					"relativeUrl": {
						"value": "@concat('https://api.nedap-bi.com/v1/behaviour/activity/animal/leg_quarter_data?animal_id=',dataset().id,'&start_date=',startOfDay(dataset().start_date),'&end_date=',startOfDay(dataset().end_date))",
						"type": "Expression"
					}
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/Nedap_API')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/API_GetCowLying')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "Nedap_API",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"id": {
						"type": "string"
					},
					"start_date": {
						"type": "string"
					},
					"end_date": {
						"type": "string"
					}
				},
				"folder": {
					"name": "Nedap API"
				},
				"annotations": [],
				"type": "RestResource",
				"typeProperties": {
					"relativeUrl": {
						"value": "@concat('https://api.nedap-bi.com/v1/behaviour/lying/animal/quarter_data?animal_id=',dataset().id,'&start_date=',startOfDay(dataset().start_date),'&end_date=',startOfDay(dataset().end_date))",
						"type": "Expression"
					}
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/Nedap_API')]"
			]
		}
	]
}